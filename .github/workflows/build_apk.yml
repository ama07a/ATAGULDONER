name: Build ATAGULDONER APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system packages
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          wget unzip zip tar git build-essential cmake automake autoconf libtool pkg-config \
          openjdk-17-jdk-headless python3-venv python3-pip make ccache \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev
      shell: bash

    - name: Prepare Android commandline tools (robust)
      id: sdkprep
      run: |
        set -euo pipefail
        ANDROID_ROOT="$RUNNER_TEMP/android-sdk"
        mkdir -p "$ANDROID_ROOT"
        echo "ANDROID_ROOT=$ANDROID_ROOT"
        CD="$RUNNER_TEMP/cmdline"
        mkdir -p "$CD"
        cd "$CD"

        # recommended stable cmdline tools zip (change version if desired)
        TOOLS_ZIP="commandlinetools-linux-9477386_latest.zip"
        if [ ! -f "$TOOLS_ZIP" ]; then
          wget -q "https://dl.google.com/android/repository/$TOOLS_ZIP"
        fi

        unzip -q "$TOOLS_ZIP" -d tmp_cmdline
        # Normalize structure so we have cmdline-tools/latest/...
        mkdir -p "$ANDROID_ROOT/cmdline-tools"
        if [ -d tmp_cmdline/cmdline-tools ]; then
          mv tmp_cmdline/cmdline-tools "$ANDROID_ROOT/cmdline-tools/latest"
        else
          mkdir -p "$ANDROID_ROOT/cmdline-tools/latest"
          mv tmp_cmdline/* "$ANDROID_ROOT/cmdline-tools/latest/" || true
        fi
        rm -rf tmp_cmdline "$TOOLS_ZIP"

        echo "ANDROID_ROOT=$ANDROID_ROOT" >> "$GITHUB_ENV"
        echo "ANDROID_CMDLINE=$ANDROID_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_ENV"
        echo "PATH=$ANDROID_ROOT/platform-tools:$ANDROID_ROOT/cmdline-tools/latest/bin:$PATH" >> "$GITHUB_ENV"
      shell: bash

      - name: Install Android SDK packages & accept licenses (robust)
      env:
        ANDROID_ROOT: ${{ env.ANDROID_ROOT }}
      run: |
        set -euo pipefail

        # choose ANDROID_HOME/ANDROID_ROOT used earlier in workflow
        ANDROID_HOME="${ANDROID_ROOT:-$RUNNER_TEMP/android-sdk}"
        mkdir -p "$ANDROID_HOME"
        export ANDROID_HOME

        # ensure sdkmanager path
        SDKMAN="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -x "$SDKMAN" ]; then
          # try any sdkmanager available on PATH
          SDKMAN=$(command -v sdkmanager || true)
        fi

        if [ -z "$SDKMAN" ]; then
          echo "ERROR: sdkmanager not found. Listing $ANDROID_HOME for debugging:"
          ls -la "$ANDROID_HOME" || true
          echo "Contents recursive:"
          ls -R "$ANDROID_HOME" || true
          exit 127
        fi

        echo "Using sdkmanager: $SDKMAN"

        # Accept licenses robustly.
        # We redirect yes's output to /dev/null to avoid Broken pipe noise,
        # and ignore non-zero exit to avoid failing when pipe closes early.
        printf '%s\n' y | "$SDKMAN" --sdk_root="$ANDROID_HOME" --licenses > /dev/null 2>&1 || true

        # helper to retry sdkmanager install (network flakiness)
        retry_cmd() {
          local tries=${1:-3}; shift
          local cmd=( "$@" )
          local i=1
          while true; do
            echo "Attempt $i: ${cmd[*]}"
            if "${cmd[@]}"; then
              return 0
            fi
            i=$((i+1))
            if [ $i -gt $tries ]; then
              echo "Command failed after $tries attempts: ${cmd[*]}"
              return 1
            fi
            echo "Sleeping before retry..."
            sleep 5
          done
        }

        # install what we need (platform-tools, platforms, build-tools, ndk)
        retry_cmd 4 "$SDKMAN" --sdk_root="$ANDROID_HOME" --install "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;25.2.9519653"

        # export envs for later steps
        echo "ANDROIDSDK=$ANDROID_HOME" >> "$GITHUB_ENV"
        echo "ANDROIDNDK=$ANDROID_HOME/ndk/25.2.9519653" >> "$GITHUB_ENV"
        echo "PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH" >> "$GITHUB_ENV"
      shell: bash


    - name: Ensure buildozer.spec (create/adjust)
      run: |
        set -euo pipefail
        # if buildozer.spec doesn't exist, initialize and replace values
        source .p4a-venv/bin/activate
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        # safe defaults (overwrite or append)
        sed -i 's/^title =.*/title = ATAGULDONER/' buildozer.spec || echo "title = ATAGULDONER" >> buildozer.spec
        sed -i 's/^package.name =.*/package.name = ataguldoner/' buildozer.spec || echo "package.name = ataguldoner" >> buildozer.spec
        sed -i 's/^package.domain =.*/package.domain = org.atagul/' buildozer.spec || echo "package.domain = org.atagul" >> buildozer.spec
        sed -i 's%^source.dir =.*%source.dir = .%' buildozer.spec || echo "source.dir = ." >> buildozer.spec
        sed -i 's/^requirements =.*/requirements = python3,pygame/' buildozer.spec || echo "requirements = python3,pygame" >> buildozer.spec
        sed -i 's/^android.api =.*/android.api = 34/' buildozer.spec || echo "android.api = 34" >> buildozer.spec
        sed -i 's/^android.ndk =.*/android.ndk = 25.2.9519653/' buildozer.spec || echo "android.ndk = 25.2.9519653" >> buildozer.spec
        sed -i 's/^android.minapi =.*/android.minapi = 24/' buildozer.spec || echo "android.minapi = 24" >> buildozer.spec
        sed -i 's/^android.accept_sdk_license =.*/android.accept_sdk_license = True/' buildozer.spec || echo "android.accept_sdk_license = True" >> buildozer.spec
        # ensure version present
        if ! grep -q '^version =' buildozer.spec; then
          echo "version = 1.0" >> buildozer.spec
        fi
      shell: bash

    - name: Run Buildozer build (debug)
      env:
        ANDROIDSDK: ${{ env.ANDROIDSDK }}
        ANDROIDNDK: ${{ env.ANDROIDNDK }}
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        PATH: ${{ env.PATH }}
      run: |
        set -euo pipefail
        source .p4a-venv/bin/activate
        export ANDROIDSDK="${ANDROIDSDK:-$RUNNER_TEMP/android-sdk}"
        export ANDROIDNDK="${ANDROIDNDK:-$ANDROIDSDK/ndk/25.2.9519653}"
        export PATH="$ANDROIDSDK/cmdline-tools/latest/bin:$ANDROIDSDK/platform-tools:$PATH"

        # Ensure project files are in repo root
        echo "Listing repo root:"
        ls -la

        # Build (this can take long)
        buildozer -v android debug || (echo "Buildozer failed â€” printing last 400 lines of output"; tail -n 400 ./.buildozer/android/platform/*/buildozer.log || true; exit 1)
      shell: bash

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ATAGULDONER-APK
        path: |
          bin/*.apk
          ~/.buildozer/android/platform/build-arm64-v8a/build/dists/*.apk
          ./.buildozer/android/platform/build/dists/*.apk
