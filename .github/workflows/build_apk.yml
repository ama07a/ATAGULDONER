name: Build ATAGULDONER APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install essential packages
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          wget unzip zip tar git build-essential cmake automake autoconf libtool pkg-config \
          python3-venv python3-pip python3-dev openjdk-17-jdk-headless \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libffi-dev libssl-dev ca-certificates
      shell: bash

    - name: Download Android cmdline-tools
      run: |
        set -euo pipefail
        mkdir -p "$RUNNER_TEMP/android-sdk/cmdline-tools"
        cd "$RUNNER_TEMP"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip -d cmdline-tools
        mv cmdline-tools "$RUNNER_TEMP/android-sdk/cmdline-tools/latest"
        echo "ANDROID_HOME=$RUNNER_TEMP/android-sdk" >> "$GITHUB_ENV"
        echo "PATH=$RUNNER_TEMP/android-sdk/cmdline-tools/latest/bin:$RUNNER_TEMP/android-sdk/platform-tools:$PATH" >> "$GITHUB_ENV"
      shell: bash

    - name: Install SDK platforms and tools
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
      run: |
        set -euo pipefail
        export ANDROID_HOME="${ANDROID_HOME:-$RUNNER_TEMP/android-sdk}"
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
        echo "Accepting licenses..."
        yes | sdkmanager --licenses >/dev/null 2>&1 || true

        echo "Installing platform-tools, build-tools, NDK, and android-34..."
        sdkmanager --sdk_root="$ANDROID_HOME" "platform-tools" "build-tools;34.0.0" "platforms;android-34" "ndk;25.2.9519653" || true

        # verify platform actually installed, retry up to 3 times
        for i in 1 2 3; do
          if [ -d "$ANDROID_HOME/platforms/android-34" ]; then
            echo "android-34 installed!"
            echo "ANDROID_API=34" >> "$GITHUB_ENV"
            break
          else
            echo "Retry $i: android-34 missing, re-installing..."
            sdkmanager --sdk_root="$ANDROID_HOME" "platforms;android-34" || true
            sleep 10
          fi
        done

        # fallback to android-33 if still missing
        if [ ! -d "$ANDROID_HOME/platforms/android-34" ]; then
          echo "Falling back to android-33..."
          sdkmanager --sdk_root="$ANDROID_HOME" "platforms;android-33" || true
          echo "ANDROID_API=33" >> "$GITHUB_ENV"
        fi

        echo "ANDROIDSDK=$ANDROID_HOME" >> "$GITHUB_ENV"
        echo "ANDROIDNDK=$ANDROID_HOME/ndk/25.2.9519653" >> "$GITHUB_ENV"
        ls -R "$ANDROID_HOME/platforms" || true
      shell: bash

    - name: Prepare virtualenv and install python-for-android
      run: |
        set -euo pipefail
        python3 -m venv .p4a
        source .p4a/bin/activate
        pip install --upgrade pip setuptools wheel
        pip install "python-for-android==2024.01.21" "Cython==3.2.0"
      shell: bash

    - name: Detect main Python file (möm.py → main.py)
      run: |
        if [ -f "main.py" ]; then
          echo "main.py found."
        elif [ -f "möm.py" ]; then
          echo "Copying möm.py → main.py"
          cp "möm.py" main.py
        elif [ -f "mom.py" ]; then
          echo "Copying mom.py → main.py"
          cp "mom.py" main.py
        else
          echo "No entry file found!"
          ls -la
        fi
      shell: bash

    - name: Build APK
      env:
        ANDROIDSDK: ${{ env.ANDROIDSDK }}
        ANDROIDNDK: ${{ env.ANDROIDNDK }}
        ANDROID_API: ${{ env.ANDROID_API }}
      run: |
        set -euo pipefail
        source .p4a/bin/activate
        echo "SDK: $ANDROIDSDK"
        echo "NDK: $ANDROIDNDK"
        echo "API: $ANDROID_API"

        if [ ! -d "$ANDROIDSDK/platforms/android-$ANDROID_API" ]; then
          echo "ERROR: android-$ANDROID_API platform not found!"
          ls -R "$ANDROIDSDK/platforms" || true
          exit 1
        fi

        p4a apk \
          --private . \
          --package=org.atagul.ataguldoner \
          --name "ATAGULDONER" \
          --version 1.0 \
          --bootstrap=sdl2 \
          --arch=arm64-v8a \
          --requirements=python3,pygame \
          --sdk-dir "$ANDROIDSDK" \
          --ndk-dir "$ANDROIDNDK" \
          --android-api="$ANDROID_API" \
          --skip-build-pygame-c \
          --debug || ( tail -n 200 ~/.local/share/python-for-android/*.log || true; exit 1 )
      shell: bash

    - name: Upload built APK
      uses: actions/upload-artifact@v4
      with:
        name: ATAGULDONER-APK
        path: |
          dist/*.apk
          bin/*.apk
          ./*.apk
